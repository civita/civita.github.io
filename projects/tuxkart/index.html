<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="qHIGKStShpF1nx-b_eFUBbwWxftiOnPdPhOJfX37XIs"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="robots" content="noindex"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>TuxKart Ice Hockey Image Agent | Michael L. Chang</title> <meta name="author" content="Michael L. Chang"> <meta name="description" content="A machine learning model that could play ice hockey in the SuperTuxKart racing game"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8C%9D&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://me.windsketch.cc/projects/tuxkart/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Michael </span>L. Chang</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/resume/">resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">TuxKart Ice Hockey Image Agent</h1> <p class="post-description">A machine learning model that could play ice hockey in the SuperTuxKart racing game</p> </header> <article> <h2 id="introduction">Introduction</h2> <p>In this project, I implemented an agent that plays the <a href="https://supertuxkart.net/" rel="external nofollow noopener" target="_blank">SuperTuxKart</a> ice hockey game mode. My goal is to train the agent to score as many goals as possible in a 2 vs. 2 tournament against some existing agents.</p> <h2 id="getting-started">Getting Started</h2> <p>First, I played the SuperTuxKart ice hockey game on my Linux machine, to familiarize with the rules, methods of controlling, the size of the court and goals, and how the AI agents act during the game. Then I think I should implement an agent based on the <em>internal world states</em> first. The specific additional world state passed to my agent is the location (heatmap) of puck in each given image. This information can be retrieved via the object <code class="language-plaintext highlighter-rouge">render_data[i].instance</code> where <code class="language-plaintext highlighter-rouge">i</code> is the ID of the player. I wrote a low-level controller based on the original information (image, kart) and the location of puck (see below).</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/IVNMteu-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/IVNMteu-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/IVNMteu-1400.webp"></source> <img src="https://i.imgur.com/IVNMteu.png" class="img-fluid z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> Original given image </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/ViMssX6-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/ViMssX6-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/ViMssX6-1400.webp"></source> <img src="https://i.imgur.com/ViMssX6.png" class="img-fluid z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> Heatmap of puck </div> </div> <p><br></p> <h2 id="low-level-controller">Low-level Controller</h2> <p>The implemented low-level controller determines its action based on several scenarios:</p> <h3 id="1-at-the-beginning-of-each-round">1. At the beginning of each round</h3> <p>To distinguish if it is the beginning of each round or not, I stored the pervious location of the kart and compared it to the current location (<code class="language-plaintext highlighter-rouge">kart.location</code>). If the distance is larger enough, new round is likely started. The importance of this part is that in the beginning the puck is too far to be noticed by merely the given image, and the kart cannot determine where to go. In my code of the controller, during the first 25 frames the kart always accelerates and use nitro if it is possible. After 25 frames, the puck is large enough and in front of the kart, the kart determines the action based on the following parts.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/Y29NwEB-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/Y29NwEB-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/Y29NwEB-1400.webp"></source> <img src="https://i.imgur.com/Y29NwEB.png" class="img-fluid z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> Image at 0 </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/0grZXRp-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/0grZXRp-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/0grZXRp-1400.webp"></source> <img src="https://i.imgur.com/0grZXRp.png" class="img-fluid z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> Heatmap of puck </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/P3pA45h-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/P3pA45h-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/P3pA45h-1400.webp"></source> <img src="https://i.imgur.com/P3pA45h.png" class="img-fluid z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> Image at 25 </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/PezEiII-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/PezEiII-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/PezEiII-1400.webp"></source> <img src="https://i.imgur.com/PezEiII.png" class="img-fluid z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> Heatmap of puck </div> </div> <p><br></p> <h3 id="2-during-the-game">2. During the game</h3> <p>The strategies of the controller are relatively basic and intuitive. The value of steering is determined by the coordinate of the puck in the image. For example, if the puck is at the right side of the image, the kart turns right (similar to our pervious homework). This ensures to keep up with the puck and avoid to get lost (to some extent). Another benefit from this strategy is that if an opponent is trying to shoot, the kart may be an obstacle and make the opponent to goal more difficult.</p> <p>There is also a target speed and the acceleration is determined by the current speed, target speed, and the size of the puck in the image.</p> <p>However, this strategy may have some issues. For example, the kart does not know that it is close to goal and it would also shoot to the opposites’, hence the following additional strategies are introduced to avoid such conditions.</p> <h3 id="3-the-kart-is-close-to-the-goal">3. The kart is close to the goal</h3> <p>If the kart is about to earn a point, the angle between the kart and two sides of that goal is calculated (\(\theta\) and \(\phi\)). If the angle is too large (for example, the kart is facing wrong direction) then it will steer to another side. The facing direction is determined by the difference between <code class="language-plaintext highlighter-rouge">player_info.kart.front</code> and <code class="language-plaintext highlighter-rouge">player_info.kart.location</code>.</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/F3HNMyz-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/F3HNMyz-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/F3HNMyz-1400.webp"></source> <img src="https://i.imgur.com/F3HNMyz.jpeg" class="img-fluid z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="4-the-kart-faces-wrong-direction-with-the-puck-in-front-of-it">4. The kart faces wrong direction with the puck in front of it</h3> <p>If the kart is facing wrong direction and pushing the puck to the opposites’ goal, it drifts and brakes immediately to prevent losing one point in the game. This strategy can be achieved by determining the x (first) coordinate and the (above-mentioned) facing direction. The reason to drift is trying to make both the puck and the kart turn around.</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/hFUfO3c-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/hFUfO3c-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/hFUfO3c-1400.webp"></source> <img src="https://i.imgur.com/hFUfO3c.jpg" class="img-fluid z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="5-there-is-no-puck-in-the-input-image">5. There is no puck in the input image</h3> <p>There is a chance that the puck is somehow not in the input image. Here we will also inspect the coordinates of the puck in the previous frame. If the puck existed in the previous frame, and the absolute value of x (long edge) coordinate is larger than the threshold (0.9 for example), then the kart will try to reverse the gear to find the puck (based on which side the puck moved away).</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/dq55te6-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/dq55te6-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/dq55te6-1400.webp"></source> <img src="https://i.imgur.com/dq55te6.jpg" class="img-fluid z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h2 id="planner">Planner</h2> <p>With the above-mentioned strategies, the kart performed acceptable results with the given internal world states. However, in real game we don’t have such internal information, and we have to design a deep network to get the heatmap by ourselves.</p> <p>Here several models are proposed. First I would like to implement a model that the input is the given image and the output is the <code class="language-plaintext highlighter-rouge">{steer value, acceleration}</code>. In this way we even don’t have to design low-level controller. However, this cannot be achieved because we are not <em>driving</em> the kart along the track and loss is difficult to be valued.</p> <p>Secondly, I came out with a model that the output is the center <code class="language-plaintext highlighter-rouge">x, y</code> coordinates of puck in each input image. This one had another issue that all the trained images contained the puck inside, and when the puck is not in the image, this model still <code class="language-plaintext highlighter-rouge">guesses</code> the coordinates of the puck (maybe refer to some black paints in other karts). I trained this one and the results are unacceptable.</p> <p>Finally, the model output is designed to be the heatmap of the puck (similar to one of our assignments). The training images were generated by playing <code class="language-plaintext highlighter-rouge">6000</code> frames between implemented agents (with given world state) and AIs (files <code class="language-plaintext highlighter-rouge">planner.py</code> and <code class="language-plaintext highlighter-rouge">train.py</code>). The results are shown below.</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/FuoVCUI-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/FuoVCUI-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/FuoVCUI-1400.webp"></source> <img src="https://i.imgur.com/FuoVCUI.png" class="img-fluid z-depth-1" width="800" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/zxnNSXD-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/zxnNSXD-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/zxnNSXD-1400.webp"></source> <img src="https://i.imgur.com/zxnNSXD.png" class="img-fluid z-depth-1" width="800" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="https://i.imgur.com/Gnql2gc-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="https://i.imgur.com/Gnql2gc-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="https://i.imgur.com/Gnql2gc-1400.webp"></source> <img src="https://i.imgur.com/Gnql2gc.png" class="img-fluid z-depth-1" width="800" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Here I also resized the input dimension from (400, 300, 3) to (128, 96, 3) because with the original size the model is too large (the required VRAM exceeds the limit) to be trained in Google Colab. The output dimension is (128, 96, 1).</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/project_tuxkart-preview.gif-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/project_tuxkart-preview.gif-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/project_tuxkart-preview.gif-1400.webp"></source> <img src="/assets/img/project_tuxkart-preview.gif" class="img-fluid z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h2 id="discussion">Discussion</h2> <p>There are several mechanisms that could be added to my implement and improve the performance. First, I read the source code of <code class="language-plaintext highlighter-rouge">pystk</code> AI in GitHub and think my implemented low-level controller is too simple (compared to the AI). I would like to add additional functions (for example, one is offensive and one is defensive). Second, the output heatmap is only for the puck in my implementation, and opponents’ kart are not recognized during the game. I would design strategy when the opponent is in front of the kart.</p> <p>From this programming final project, I’ve learned how to implement the deep network based on several scenarios and design the loss accordingly. The methods of choosing suitable output are very important and would affect the results hugely.</p> <p>In addition, I also realized that instead of trial-and-error, we should explain the results and find better approaches to improve the performance. If we just try different combinations of parameters without thinking the meaning behind it, it is just a waste of time. I think my implemented model is reasonable, but it still needs time to optimize it.</p> </article> </div> </div> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script>fetch("api/discord");</script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-FJ6KMF48XE"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-FJ6KMF48XE");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>